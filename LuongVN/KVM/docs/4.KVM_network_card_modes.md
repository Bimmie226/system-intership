# Phân tích đường đi gói tin với chế độ card mạng Bridged và NAT
## I. Bridged
![alt text](../images/bridged_01.png)

### 1. Các thành phần trong sơ đồ bridged
**Server with Hypervisor:** 
- Đây là máy chủ vật lý đang chạy một hypervisor (như KVM)

**Hai máy chủ ảo (Virtual Machines):** 
- Đây là các máy ảo (VM) được tạo và chạy trên hypervisor

**vNIC(Virtual Network Interface Card):** 
- Mỗi máy ảo có một card mạng ảo (vNIC)

**Virtual Switch:** 
- Là một thành phần phần mềm được tạo và quản lý bởi Hypervisor trên Server. Trong KVM, đây chính là Linux Bridge(ví dụ: `br0`)

**pNIC (Physical Network Interface Card):** 
- card mạng vật lý trên server, kết nối vợi mạng bên ngoài 

**Physical switch:** 
- Switch vật lý nằm ngoài server, kết nối server với mạng bên ngoài

**External Network:** 
- Đại diện cho mạng bên ngoài 

### 2. Cách thức hoạt động Bridged
#### 2.1. Kết nối bên trong server ảo:
- Mỗi vNIC của máy ảo được kết nối trực tiếp vào Virtual Switch
- Các pNIC của server cũng được kết nối vào Virtual Switch
- Điều này tạo ra một "cầu nối" logic, nơi Virtual Switch đóng vai trò trung gian kết nối giữa các máy ảo và giữa máy ảo với mạng vật lý bên ngoài thông qua pNIC.


#### 2.2. Giao tiếp giữa các VM (nội bộ trên cùng Host)
Khi một gói tin từ một máy ảo muốn gửi đến máy ảo khác trên cùng 1 server:

- Gói tin từ vNIC của VM đi vào virtual switch
- Virtual switch sẽ kiểm tra địa chỉ MAC của gói tin. Nếu địa chỉ MAC đích là của một vNIC khác cũng được kết nối với virtual switch, virtual switch sẽ chuyển tiếp gói tin đó trực tiếp đến vNIC của VM đích
- Trong sơ đồ: `VM1 -> vNIC -> Virtual Switch -> vNIC -> VM2`

#### 2.3. Giao tiếp giữa VM và External Network 
Khi một gói tin từ máy ảo muốn đi ra ngoài internet:

- Gói tin từ vNIC của VM đi vào Virtual Switch
- Virtual Switch kiểm tra địa chỉ MAC đích. Nếu địa chỉ MAC đích nằm ngoài Server nó sẽ chuyển tiếp gói tin đó qua 1 trong các pNIC được kết nối với nó.
- pNIC sẽ gửi gói tin ra Physical Switch và đỉ ra internet
- Trong sơ đồ: `VM -> vNIC -> Virtual Switch -> pNIC -> Physical Switch -> External Network`


## II. NAT
![alt text](../images/nat_01.png)

### 1. Các thành phần trong sơ đồ NAT
**Host machine (Máy chủ KVM):**
- Đây là máy vật lý chạy hệ điều hành linux nơi cài đặt KVM và `libvirt`

**Virtual Machine:** 
- Máy ảo được tạo trên KVM

**Virtual Network adapter (Card mạng ảo của VM):**
- Card mạng mà ta gán cho máy ảo

**Virtual Network Switch "virbr0" (Switch ảo):**
- Một switch ảo được tạo ra trên Host Machine. `virbr0` là tên mặc định cho mạng ảo NAT mặc định trong `libvirt`.

**NAT Device:** 
- Đây là một thành phần ảo hoạt động như 1 Router có chức năng NAT. Nó được tích hợp vào mạng ảo `virbr0`

**DHCP Server:**
- 1 máy chủ DHCP ảo cũng được tích hợp vào card mạng ảo `virbr0`. Nhiệm vụ của nó là cấp phát địa chỉ IP tự động cho các máy ảo kết nối vào `virbr0`

**Network (Mạng bên ngoài)**


### 2. Cách thức hoạt động NAT
#### 2.1. Kết nối nội bộ trong host:
- Card mạng ảo của VM được kết nối vào Virtual Network Switch `virbr0`
- NAT Device và DHCP Server cũng được kết nối vào `virbr0`

#### 2.2. Cấp phát IP cho VM:
- Khi VM khởi động, nó sẽ gửi yêu cầu DHCP
- DHCP Server sẽ cấp phát 1 địa chỉ IP cho VM. IP này thuộc một mạng con riêng biệt và biệt lập được quản lý bởi `virbr0`

#### 2.3. Định tuyến và NAT ra mạng ngoài
- Khi VM gửi gói tin ra Network, gói tin sẽ đi từ card mạng ảo của VM đến `virbr0`
- Sau đó gói tin được chuyển đến `NAT Device` để thay đổi source IP của gói tin từ IP riêng của VM thành IP của Host Machine trên mạng vật lý 
- Sau khi NAT, gói tin được gửi ra Network thông qua card mạng vật lý của host machine
- Khi có phản hồi từ Network, gói tin sẽ đến Host Machine, NAT Device sau đó đảo ngược quá trình, thay dest IP từ IP của host machine thành IP private của VM, sau đó chuyển gói tin đến `virbr0` và cuối cùng là về `VM`

