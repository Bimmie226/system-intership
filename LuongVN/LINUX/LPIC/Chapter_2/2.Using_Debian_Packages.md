# USING DEBIAN PACKAGES
Debian được sử dụng chủ yếu trên các bản phân phối linux dựa trên Debian, chẳng hạn như Ubuntu.

## Debian Package File Conventions
Các ứng dụng trong Debian được đóng gói trong một file có phần mở rộng `.deb`, với cấu trúc tên:
```pgsql
PACKAGE-NAME-VERSION-RELEASE_ARCHITECTURE.deb
```
-> Cấu trúc này tương tự như định dạng `.rpm` của Red Hat.

## The `dpkg` Command Set
1) Giới thiệu:
- `dpkg` là công cụ dòng lệnh chính để làm việc với các gói Debian(`.deb`).
- Cho phép cài đặt, cập nhật, xem thông tin, gỡ bỏ gói phần mềm.
- Cú pháp:
```bash
dpkg [OPTION] ACTION PACKAGE-FILE
```

2) Các hành động (ACTION) thường dùng
  
| Short | Long               | Mô tả                                |
| ----- | ------------------ | ------------------------------------ |
| `-c`  | `--contents`       | Xem nội dung gói                     |
| `-C`  | `--audit`          | Tìm gói bị hỏng và gợi ý cách sửa    |
| —     | `--configure`      | Cấu hình lại gói đã cài              |
| —     | `--get-selections` | Liệt kê các gói hiện đang cài        |
| `-i`  | `--install`        | Cài hoặc nâng cấp gói                |
| `-I`  | `--info`           | Xem thông tin gói chưa cài           |
| `-l`  | `--list`           | Liệt kê các gói đã cài phù hợp mẫu   |
| `-L`  | `--listfiles`      | Liệt kê file thuộc gói               |
| `-p`  | `--print-avail`    | Xem thông tin gói đã cài             |
| `-P`  | `--purge`          | Gỡ hoàn toàn gói (kèm file cấu hình) |
| `-r`  | `--remove`         | Gỡ gói nhưng giữ lại file cấu hình   |
| `-s`  | `--status`         | Hiển thị trạng thái gói              |
| `-S`  | `--search`         | Tìm gói sở hữu một file cụ thể       |

3) Trước khi dùng `dpkg`:
- Cần tải gói `.deb` về hệ thống trước.
- Các gói này có thể lấy từ web chính thức hoặc kho lưu trữ của distro

4) Xem thông tin gói chưa cài (`-I`)
```bash
dpkg -I zsh_5.4.2-3ubuntu3.1_amd64.deb
```
→ Hiển thị thông tin như: tên gói, phiên bản, kiến trúc, người duy trì, phụ thuộc (Depends), đề xuất (Recommends), mô tả, trang chủ,...

5) Xem nội dung trong gói(`--contents`)
- Dùng dpkg `--contents package.deb` để xem danh sách file.

- Có thể pipe qua `less` để đọc dễ hơn:
  ```bash
  dpkg --contents zsh_5.4.2-3ubuntu3.1_amd64.deb | less
  ```

6) Cài đặt gói(`-i`):
```bash
sudo dpkg -i zsh_5.4.2-3ubuntu3.1_amd64.deb
```

7) Xem trạng thái gói(`-s`)
```bash
dpkg -s zsh
```

8) Liệt kê tất cả gói đã cài (`-l`):
```bash
dpkg -l
```
→ Kết quả có mã trạng thái ở cột đầu tiên:

  - `ii` → đã cài hoàn chỉnh

  - `iU` → gói được cài nhưng chưa cấu hình xong (thường do thiếu phụ thuộc)

9) Gỡ gói (`-r` và `-P`):
- Gỡ nhưng giữ cấu hình:
```bash
sudo dpkg -r zsh
```
- Gỡ hoàn toàn:
```bash
sudo dpkg -P zsh
```
-> Xóa cả gữ liệu và file cấu hình.

## Hoạt động chi tiết của `dpkg`
### Khi cài đặt gói bằng `dpkg`
Ví dụ:
```bash
sudo dpkg -i ten_goi.deb
```

1) Giải nén gói `.deb`
- Tên gói, phiên bản
- các gói phụ thuộc(depends, conflicts, ...)
- Các script cần chạy trong các giai đoạn cài đặt

2) Kiểm tra trạng thái gói trong hệ thống
`dpkg` tra cứu trong db `/var/lib/dpkg/status` để xem gói đó:
- Đã cài chưa
- Ở trạng thái gì
- Có xung đột với gói khác ko

3) thực thi script trước cài đặt

4) Giải nén file
- Các file được giải nén vào đúng vị trí trong hệ thống(ví dụ `/usr/bin`, `/etc/`, `/lib/`...)
- nếu file đã tồn tại, `dpkg` sẽ:
  - Ghi đè
  - Hoặc lừu file khác

5) Thực thi script sau cài đặt

6) Cập nhật lại cơ sở dữ liệu
- `dpkg` ghi lại thông tin vào: `/var/lib/dpkg/status`

### Khi gỡ gói bằng `dpkg`
Ví dụ:
```bash
sudo dpkg -r nginx
```

1) Kiểm tra trạng thái gói
- `dpkg` đọc file cơ sở dữ liệu: `/var/lib/dpkg/status`
- Gói được cài chưa?

2) Gọi script trước khi xóa

3) Xóa file chương trình
- Xóa toàn bộ file dữ liệu của gói (được liệt kê trong `/var/lib/dpkg/info/nginx.list`)

- Các file cấu hình (trong `/etc`) được giữ lại nếu chỉ `-r`, nhưng bị xóa luôn nếu bạn dùng `-P`.

4) Gọi script sau xóa

5) Cập nhật lại db trong `/var/lib/dpkg/status`

### Khi cập nhật gói bằng `dpkg`
Ví dụ:
```bash
sudo dpkg -i gói_mới.deb
```

1) Giải nén và đọc metadata của gói mới
- Giống như khi cài mới, dpkg mở file .deb, đọc phần:
  - thông tin gói, script
  - nội dung chương trình

- Đọc `Package`, `Version`, `Depends`, `Conflicts`, v.v.

- So sánh phiên bản hiện tại và phiên bản mới trong `/var/lib/dpkg/status`

2) Xác định hành động:
- Cùng tên, phiên bản mới hơn -> nâng cấp
- Cùng tên, xung đội -> xử lý thay thế
- khác tên -> xử lý như gói mới hoàn toàn

3) Thực thi script trước cài đặt

4) giải nén file chương trình(giống như giải nén file khi cài đặt)

5) Thực thi script sau khi cài đặt

6) Cập nhật db trong `/var/lib/dpkg/status`

## Using apt-cache
`apt-cache` không cài hay gỡ phần mềm, nó chỉ tra cứu thông tin về các gói: tên, phiên bản, ...

- Các lệnh quan trọng của `apt-cache`

| Câu lệnh                  | Mô tả                                                               | Ví dụ                              |
| ------------------------- | ------------------------------------------------------------------- | ---------------------------------- |
| `apt-cache pkgnames`      | Hiển thị **toàn bộ gói cài đặt trên hệ thống**                      | `apt-cache pkgnames \| grep ^nano` |
| `apt-cache search <tên>`  | Tìm các gói có từ khóa trong tên/mô tả                              | `apt-cache search zsh`             |
| `apt-cache showpkg <tên>` | Xem thông tin chi tiết về gói (phiên bản, phụ thuộc, gói liên quan) | `apt-cache showpkg zsh`            |
| `apt-cache depends <tên>` | Liệt kê **các gói phụ thuộc (dependencies)** của gói đó             | `apt-cache depends zsh`            |
| `apt-cache stats`         | Thống kê tổng quát kho gói (bao nhiêu gói, kích thước, v.v.)        | `apt-cache stats`                  |
| `apt-cache unmet`         | Liệt kê các **phụ thuộc chưa được thỏa mãn** (unmet dependencies)   | `apt-cache unmet`                  |

![alt text](../images/2_2_01.png)

## Using apt-get
- `apt-get` là trình quản lý gói chính trong APT (Advanced Package Tool).

- Dùng để tương tác trực tiếp với kho phần mềm (repository): tải, cài, cập nhật, xóa.

- Các lệnh quan trọng của `apt-get`

| Lệnh                      | Ý nghĩa                                                         | Ghi nhớ nhanh            |
| ------------------------- | --------------------------------------------------------------- | ------------------------ |
| `apt-get update`          | Cập nhật **danh sách gói** trong hệ thống (chưa cài gì cả)      |  Làm mới “danh bạ gói” |
| `apt-get install <gói>`   | Cài đặt gói (và các gói phụ thuộc nếu cần)                      |  Cài phần mềm          |
| `apt-get remove <gói>`    | Gỡ gói nhưng **giữ lại file cấu hình**                          |  Gỡ nhẹ                |
| `apt-get purge <gói>`     | Gỡ gói **và xóa luôn cấu hình**                                 |  Gỡ sạch               |
| `apt-get upgrade`         | Cập nhật tất cả gói đang cài lên **phiên bản mới nhất an toàn** | ⬆ Cập nhật cơ bản       |
| `apt-get autoclean`       | Xóa các file `.deb` tải về **đã cũ**                            |  Dọn tệp cũ            |
| `apt-get clean`           | Xóa **toàn bộ cache tải về**                                    |  Dọn sạch cache        |
| `apt-get check`           | Kiểm tra **lỗi trong cơ sở dữ liệu gói**                        |  Kiểm tra hệ thống     |
| `apt-get source <gói>`    | Tải **mã nguồn (source code)** của gói                          |  Dành cho dev          |

![alt text](../images/2_2_02.png)

## Hoạt động chi tiết của `apt`
### Khi cài đặt gói bằng `apt`
```bash
sudo apt install nginx
```

1) Phân tích yêu cầu
- Tra trong danh sách gói (`/var/lib/apt/lists/`) để tìm tên và phiên bản phù hợp
- Kiểm tra các quan hệ phụ thuộc:
- Nếu thiếu apt tự thêm chúng vào cài đặt

2) Tải gói .deb vào hệ thống
- Tải toàn bộ gói cần thiết về thư mục cache: `/var/cache/apt/archives/`


3) Kiểm tra toàn vẹn và xác thực:
- Thông qua SHA256 
- Nếu ko khớp -> dừng ngay

4) Thực hiện cài đặt qua `dpkg`
- giống lệnh `dpkg -i`
- Ghi lại db `/var/lib/dpkg/status`

5) Cập nhật lại db `/var/lib/apt/lists`

### Khi xóa gói bằng `apt`
```bash
sudo apt remove <gói>
```

1) Kiểm tra thông tin trong db `/var/lib/apt/lists`
2) Giải quyết phụ thuộc tự động
3) Gọi `dpkg` để thực hiện gỡ
- Giống lệnh `dpkg -r`
- Cập nhật lại db của dpkg

4) Cập nhật lại db của apt tại `/var/lib/apt/lists`

### Khi cập nhật gói bằng `apt`
```bash
sudo apt update
sudo apt upgrade
```

#### khi chạy `sudo apt update`
1) Đọc file cấu hình trong repository
```bash
/etc/apt/sources.list
/etc/apt/sources.list.d/*.list
```

2) Lưu metadata mới vào csdl cục bộ `/var/lib/apt/lists/`

->apt update chỉ làm mới db không cập nhật phần mềm

#### Khi chạy `sudo apt upgrade`

1) Đọc db cục bộ
- so sánh thông tin từ `/var/lib/dpkg/status` và `/var/lib/apt/lists/`

2) Xác định các gói cập nhật
- Nêu s1 gói có phiên bản mới trong repo -> thêm vào danh sách upgrade

3) Giải quyết phụ thuộc
- Kiểm tra xem gói mới yêu cầu thư viện nào.

- Đảm bảo không xung đột.

- Nếu cần thêm gói phụ trợ, nó sẽ tự thêm.

4) Tải xuống các gói `.deb` mới
- Các file `.deb` được tải về:
```bash
/var/cache/apt/archives/
```

5) Cài đặt từng gói bằng `dpkg`
- Ghi thông tin vào db `/var/lib/dpkg/status`.

6) Cập nhật lại db của apt tại: `/var/lib/apt/lists/`