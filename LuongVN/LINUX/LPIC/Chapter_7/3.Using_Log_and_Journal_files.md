# USING LOG AND JOURNAL FILES
- Logging là quá trình ghi lại các sự kiện xảy ra trên hệ thống
- Mỗi bản phân phối Linux đều có cơ chế logging riêng, nhưng về cơ bản sẽ là:
  - Ghi lại thông điệp ngắn gọn mô tả sự kiện
  - Thời điểm sự kiện xảy ra
  - Nguồn của sự kiện(tiến trình, ng dùng, kernel, ...)

- File log được ghi vào thư mục `/var/log`

## Examining the syslog Protocol
- 1980, Eric Allman đã tạo ra một giao thức chuẩn để ghi log: gọi là `syslog protocol`

- `Facility` - loại nguồn phát sóng

  | Code  | Keyword       | Mô tả                                                    |
  | ----- | ------------- | -------------------------------------------------------- |
  | 0     | kern          | Log từ kernel hệ thống                                   |
  | 1     | user          | Log từ người dùng                                        |
  | 2     | mail          | Log từ ứng dụng mail                                     |
  | 3     | daemon        | Log từ các tiến trình nền (background daemons)           |
  | 4     | auth          | Log bảo mật / xác thực                                   |
  | 5     | syslog        | Log của chính dịch vụ syslog                             |
  | 6     | lpr           | Log từ dịch vụ in ấn                                     |
  | 7     | news          | Log từ dịch vụ news cũ của Unix                          |
  | 8     | uucp          | Log từ chương trình Unix-to-Unix copy                    |
  | 9     | cron          | Log từ trình lập lịch cron                               |
  | 10    | authpriv      | Log bảo mật riêng tư                                     |
  | 11    | ftp           | Log từ dịch vụ FTP                                       |
  | 12    | ntp           | Log từ dịch vụ đồng bộ thời gian (Network Time Protocol) |
  | 13    | security      | Log kiểm toán bảo mật                                    |
  | 14    | console       | Log cảnh báo trực tiếp đến console                       |
  | 15    | solaris-cron  | Loại log cron khác                                       |
  | 16–23 | local0–local7 | Dự trữ cho log tùy chỉnh của từng hệ thống hoặc ứng dụng |

  -> `facility` cho biết ai là người tạo ra log

- `Severity`- Mức độ nghiêm trọng của log

  | Code | Keyword     | Ý nghĩa                                        |
  | ---- | ----------- | ---------------------------------------------- |
  | 0    | **emerg**   | Hệ thống **không thể sử dụng được**            |
  | 1    | **alert**   | Cần hành động **ngay lập tức**                 |
  | 2    | **crit**    | Lỗi nghiêm trọng, nhưng hệ thống vẫn chạy được |
  | 3    | **err**     | Lỗi cho phép tiếp tục hoạt động                |
  | 4    | **warning** | Cảnh báo bất thường, chưa lỗi nhưng cần chú ý  |
  | 5    | **notice**  | Thông tin bình thường nhưng **quan trọng**     |
  | 6    | **info**    | Thông báo thông tin (informational)            |
  | 7    | **debug**   | Thông tin phục vụ **debug** ứng dụng           |

- Kết hợp Facility + Severity:
  - Mỗi log trong syslog thường được gắn cặp giá trị:

    ```bash
    <facility, severity>
    ```

  - Ví dụ:
    - `<0, 3>` log lỗi (`err`) của kernel
    - `<4, 1>` Cảnh báo bảo mật (`alert`) từ module xác thực


## Logging Basics Using `rsyslogd`
### Configuring `rsyslogd`
1) `rsyslogd`
- là chương trình xử lý log chính
- Chịu trách nhiệm:
  - Nhận thông điệp log từ kernel, hệ thống, ứng dụng
  - Xử lý(lọc, định tuyến, định dạng)
  - Ghi chúng vào file, gửi đi host khác, hoặc hiển thị cho người dùng

2) File cấu hình của `rsyslog`
- `/etc/rsyslog.conf` – file cấu hình chính
- `/etc/rsyslog.d/*.conf` – các file cấu hình phụ (tách riêng cho từng dịch vụ)

3) Cấu trúc
- Mỗi dòng cấu hình có dạng:

  ```bash
  facility.priority   action
  ```

- các loại hành động:

  | Loại action               | Ví dụ                  | Ý nghĩa                                  |                                  |
  | ------------------------- | ---------------------- | ---------------------------------------- | -------------------------------- |
  | Ghi vào file              | `/var/log/syslog`      | Lưu vào tệp                              |                                  |
  | Gửi qua pipe              | `"kí tự pipe"/usr/bin/logger`                         | Chuyển log đến chương trình khác |
  | Hiển thị console          | `/dev/console`         | In ra màn hình console hệ thống          |                                  |
  | Gửi host từ xa            | `@192.168.1.10`        | Gửi log qua mạng đến syslog server       |                                  |
  | Gửi user cụ thể           | `root`                 | Gửi tin nhắn đến user đó                 |                                  |
  | Gửi tất cả user đăng nhập | `*` hoặc `:omusrmsg:*` | Gửi cảnh báo đến tất cả user đang online |                                  |

### Sending Log Messages to a Log Server
- Có nhiều máy Linux (client), và muốn tất cả log hệ thống được gửi về một máy trung tâm (log server).
- Ví dụ:
  - Client: `web01`, `db01`, `mail01`, ...
  - Log server: `loghost.ivytech.edu`
  
  → Thay vì phải SSH vào từng máy để xem log, bạn chỉ cần kiểm tra log tại log server.


- Cấu hình trong `/etc/rsyslog.conf` trên máy client
  - Thêm dòng: `*.* @@(z9)loghost.ivytech.edu:6514

  - Giải thích:
    - `*.*` - Gửi mọi log từ mọi dịch vụ với mọi mức độ nghiêm trọng
    - `@` - Gửi log qua UDP
    - `@@` - Gửi log qua TCP
    - `(z9)` - nén zlib
    - `loghost.ivytech.edu` - tên hoặc IP của log server
    - `:6514` - cổng port mà logserver lắng nghe

- Sau khi cấu hình xong: restart lại dịch vụ:

  ```bash
  sudo systemctl restart rsyslog
  ```

### Rotating Log Files
- Máy chủ Linux sinh ra rất nhiều log. Nếu để lâu, các file này có thể lên tới hàng GB -> chiếm hết ổ đĩa

- `logrotate` là tiện ích giúp:
  - Tự động xoay vòng log (rotate) theo thời gian (ngày, tuần, tháng) hoặc dung lượng file.

  - Đổi tên log cũ và tạo log mới rỗng.

  - Có thể nén, xóa, hoặc gửi qua email log cũ.

  - Thường được chạy tự động hàng ngày nhờ cron job `/etc/cron.daily/logrotate`
- File cấu hình chính: `/etc/logrotate.conf`
- Thư mục chứa các file riêng cho từng dịch vụ: `/etc/logrotate.d/`