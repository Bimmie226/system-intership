# USING LOG AND JOURNAL FILES
- Logging là quá trình ghi lại các sự kiện xảy ra trên hệ thống
- Mỗi bản phân phối Linux đều có cơ chế logging riêng, nhưng về cơ bản sẽ là:
  - Ghi lại thông điệp ngắn gọn mô tả sự kiện
  - Thời điểm sự kiện xảy ra
  - Nguồn của sự kiện(tiến trình, ng dùng, kernel, ...)

- File log được ghi vào thư mục `/var/log`

## Examining the syslog Protocol
- 1980, Eric Allman đã tạo ra một giao thức chuẩn để ghi log: gọi là `syslog protocol`

- `Facility` - loại nguồn phát sóng

  | Code  | Keyword       | Mô tả                                                    |
  | ----- | ------------- | -------------------------------------------------------- |
  | 0     | kern          | Log từ kernel hệ thống                                   |
  | 1     | user          | Log từ người dùng                                        |
  | 2     | mail          | Log từ ứng dụng mail                                     |
  | 3     | daemon        | Log từ các tiến trình nền (background daemons)           |
  | 4     | auth          | Log bảo mật / xác thực                                   |
  | 5     | syslog        | Log của chính dịch vụ syslog                             |
  | 6     | lpr           | Log từ dịch vụ in ấn                                     |
  | 7     | news          | Log từ dịch vụ news cũ của Unix                          |
  | 8     | uucp          | Log từ chương trình Unix-to-Unix copy                    |
  | 9     | cron          | Log từ trình lập lịch cron                               |
  | 10    | authpriv      | Log bảo mật riêng tư                                     |
  | 11    | ftp           | Log từ dịch vụ FTP                                       |
  | 12    | ntp           | Log từ dịch vụ đồng bộ thời gian (Network Time Protocol) |
  | 13    | security      | Log kiểm toán bảo mật                                    |
  | 14    | console       | Log cảnh báo trực tiếp đến console                       |
  | 15    | solaris-cron  | Loại log cron khác                                       |
  | 16–23 | local0–local7 | Dự trữ cho log tùy chỉnh của từng hệ thống hoặc ứng dụng |

  -> `facility` cho biết ai là người tạo ra log

- `Severity`- Mức độ nghiêm trọng của log

  | Code | Keyword     | Ý nghĩa                                        |
  | ---- | ----------- | ---------------------------------------------- |
  | 0    | **emerg**   | Hệ thống **không thể sử dụng được**            |
  | 1    | **alert**   | Cần hành động **ngay lập tức**                 |
  | 2    | **crit**    | Lỗi nghiêm trọng, nhưng hệ thống vẫn chạy được |
  | 3    | **err**     | Lỗi cho phép tiếp tục hoạt động                |
  | 4    | **warning** | Cảnh báo bất thường, chưa lỗi nhưng cần chú ý  |
  | 5    | **notice**  | Thông tin bình thường nhưng **quan trọng**     |
  | 6    | **info**    | Thông báo thông tin (informational)            |
  | 7    | **debug**   | Thông tin phục vụ **debug** ứng dụng           |

- Kết hợp Facility + Severity:
  - Mỗi log trong syslog thường được gắn cặp giá trị:

    ```bash
    <facility, severity>
    ```

  - Ví dụ:
    - `<0, 3>` log lỗi (`err`) của kernel
    - `<4, 1>` Cảnh báo bảo mật (`alert`) từ module xác thực


## Logging Basics Using `rsyslogd`
### Configuring `rsyslogd`
1) `rsyslogd`
- là chương trình xử lý log chính
- Chịu trách nhiệm:
  - Nhận thông điệp log từ kernel, hệ thống, ứng dụng
  - Xử lý(lọc, định tuyến, định dạng)
  - Ghi chúng vào file, gửi đi host khác, hoặc hiển thị cho người dùng

2) File cấu hình của `rsyslog`
- `/etc/rsyslog.conf` – file cấu hình chính
- `/etc/rsyslog.d/*.conf` – các file cấu hình phụ (tách riêng cho từng dịch vụ)

3) Cấu trúc
- Mỗi dòng cấu hình có dạng:

  ```bash
  facility.priority   action
  ```

- các loại hành động:

  | Loại action               | Ví dụ                  | Ý nghĩa                                  |                                  |
  | ------------------------- | ---------------------- | ---------------------------------------- | -------------------------------- |
  | Ghi vào file              | `/var/log/syslog`      | Lưu vào tệp                              |                                  |
  | Gửi qua pipe              | `"kí tự pipe"/usr/bin/logger`                         | Chuyển log đến chương trình khác |
  | Hiển thị console          | `/dev/console`         | In ra màn hình console hệ thống          |                                  |
  | Gửi host từ xa            | `@192.168.1.10`        | Gửi log qua mạng đến syslog server       |                                  |
  | Gửi user cụ thể           | `root`                 | Gửi tin nhắn đến user đó                 |                                  |
  | Gửi tất cả user đăng nhập | `*` hoặc `:omusrmsg:*` | Gửi cảnh báo đến tất cả user đang online |                                  |

### Sending Log Messages to a Log Server
- Có nhiều máy Linux (client), và muốn tất cả log hệ thống được gửi về một máy trung tâm (log server).
- Ví dụ:
  - Client: `web01`, `db01`, `mail01`, ...
  - Log server: `loghost.ivytech.edu`
  
  → Thay vì phải SSH vào từng máy để xem log, bạn chỉ cần kiểm tra log tại log server.


- Cấu hình trong `/etc/rsyslog.conf` trên máy client
  - Thêm dòng: `*.* @@(z9)loghost.ivytech.edu:6514`

  - Giải thích:
    - `*.*` - Gửi mọi log từ mọi dịch vụ với mọi mức độ nghiêm trọng
    - `@` - Gửi log qua UDP
    - `@@` - Gửi log qua TCP
    - `(z9)` - nén zlib
    - `loghost.ivytech.edu` - tên hoặc IP của log server
    - `:6514` - cổng port mà logserver lắng nghe

- Sau khi cấu hình xong: restart lại dịch vụ:

  ```bash
  sudo systemctl restart rsyslog
  ```

### Rotating Log Files
- Máy chủ Linux sinh ra rất nhiều log. Nếu để lâu, các file này có thể lên tới hàng GB -> chiếm hết ổ đĩa

- `logrotate` là tiện ích giúp:
  - Tự động xoay vòng log (rotate) theo thời gian (ngày, tuần, tháng) hoặc dung lượng file.

  - Đổi tên log cũ và tạo log mới rỗng.

  - Có thể nén, xóa, hoặc gửi qua email log cũ.

  - Thường được chạy tự động hàng ngày nhờ cron job `/etc/cron.daily/logrotate`
- File cấu hình chính: `/etc/logrotate.conf`
- Thư mục chứa các file riêng cho từng dịch vụ: `/etc/logrotate.d/`

### Tạo log bằng `logger`
- Khi viết script hoặc chương trình riêng, muốn lưu lại các sự kiện(event) vào hệ thống log chung của linux.
- Công cụ dùng để làm việc đó là:

  ```bash
  logger [-isd] [-f file] [-p priority] [-t tag] [-u socket] [message]
  ```

  - `-i`: thêm PID của tiến trình tạo ra log vào thông điệp
  - `-p priority`: đặt độ ưu tiên (priority) cho thông điệp, vi dụ: `user.info`, `user.warn`, `auth.error`, ...
  - `-t tag`: thêm thẻ (tag) giúp dễ nhận diện log khi tìm kiếm
  - `-f file`: lấy nội dung log từ 1 file thay vì nhập trực tiếp
  - `-s`: gửi thông điệp đồng thời ra stderr
  - `-d`, `-u`: các tùy chọn nâng cao, thường dùng để gửi log qua mạng hoặc socket

- Ví dụ: 
  ```bash
  $ logger this is a test message from luongvn
  ```

- Khi chạy xong, có thể xem log đó trong `/var/log/syslog`:

  ```bash
  $ tail /var/log/syslog
  ```

### Tìm và xem log hệ thống
- Các log hệ thống nằm trong thư mục: `/var/log`.
- Một số log phổ biến:
  - `/var/log/syslog` -> log hệ thống chúng(ubuntu)
  - `/var/log/messages` -> log chung(centos, rocky)
  - `/var/log/auth.log` -> log xác thực(đăng nhập, sudo, SSH)
  - `/var/log/apache2/` -> log riêng của web server Apache

### Theo dõi log theo thời gian thực:

```bash
tail -f /var/log/syslog
```

→ Hiển thị các dòng log mới được thêm vào liên tục (thường dùng khi debug hệ thống hoặc chạy server).

## Journaling with `systemd-journald`
- `systemd-journald` là dịch vụ(daemon) đi kèm trong các hệ thống Linux hiện đại, có nhiệm vụ:
  - Thu thập, lưu trữ và quản lý các thôgn điệp sự kiện(event messages) từ:
    - Kernel
    - Dịch vụ systemd(service start/stop, boot logs, ...)
    - Các tiến trình người dùng
    - Thông điệp từ `syslog` truyền thống

### Configuring systemd-journald
1) Tập tin cấu hình `systemd-journald`
- Đường dẫn: 

  ```bash
  /etc/systemd/journald.conf
  ```

- Dùng để điều chỉnh cách `systemd-journald` thu thập, lưu trữ, nén và giới hạn dung lượng log
- Sau khi chỉnh file này, cần reload lại dịch vụ

  ```bash
  sudo systemctl restart systemd-journald
  ```

2) Các directive thường được chỉnh trong `journald.conf`
- `Storage=`
  - Quy định cách lưu log(journald)
  - Có 4 giá trị:

  | Giá trị             | Ý nghĩa                                                                                                                              |
  | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
  | `auto` *(mặc định)* | Nếu có `/var/log/journal` → lưu log **vĩnh viễn (persistent)**. Nếu không có → lưu tạm trong `/run/log/journal` (bị xóa khi reboot). |
  | `persistent`        | Luôn lưu log **vĩnh viễn** trong `/var/log/journal`. Nếu thư mục chưa có, `systemd-journald` sẽ tự tạo.                              |
  | `volatile`          | Luôn lưu log **tạm thời** trong `/run/log/journal` (mất sau khi tắt máy).                                                            |
  | `none`              | **Tắt hoàn toàn việc lưu log** (mọi sự kiện bị bỏ qua).                                                                              |

  - Nếu muốn giữ log sau khi reboot, dùng `persistent`

- `Compress=`
  - Cho phép nén file journald để tiết kiệm dung lượng
  - Mặc định: `yes`(bật)
  - Có thể tắt bằng `no`
  
- `ForwardToSyslog=`
  - Nếu `yes` -> các log từ journald sẽ chuyển tiếp(forward) sang dịch vụ syslog như `rsyslogd`.
  - Mặc định `yes`
  - Nếu chỉ dùng journald và muốn tiết kiệm tài nguyên(không ghi đè log hai lần) có thể tắt

- `ForwardToWall=`
  - Nếu `yes` -> các thông điệp quan trọng sẽ gửi wall message đến mọi người dùng đang đăng nhập(hiển thị trên terminal)
  - Ví dụ: thông báo hệ thống sắp shutdown

- `MaxFileSec=`
  - Thời gian tối đã trước khi journald file được xoay vòng(rotate)
  - Mặc định: `1month`
  - Ví dụ:
    ```bash
    MaxFileSec=1week
    ```

  - Nếu không muốn giới hạn, đặt `0`.

- `RuntimeKeepFree=`
  - Khi lưu log tạm thời(volatile), quy định phần dung lượng ổ đĩa phải luôn chừa trống cho hệ thống
  - Mặc định: `15%` dung lượng đĩa

- `RuntimeMaxFileSize=` và `RuntimeMaxUse=`
  - Giới hạn kích thước và tổng dung lượng mà log tạm thời(trong `/run/log/journald`) được phép dùng.
  - Ví dụ:

    ```bash
    RuntimeMaxUse=200M
    ```

- `SystemKeepFree=`, `SystemMaxFileSize=`, `SystemMaxUse=`
  - Tương tự 3 dòng trên, nhưng áp dụng cho log vĩnh viễn trong `/var/log/journald`
  - Giúp tránh việc journald chiếm hết ổ đĩa
  - Ví dụ:

    ```bash
    SystemMaxUse=1G
    ```

### Looking at Journald Files
1) Journal Files là gì?
- Khi `systemd-journald` ghi log, thay vì tạo một file text như `/var/log/syslog`, nó tạo các file nhị phân có tên như sau:

  ```pgsql
  system.journal
  user-1000.journal
  user-1001.journal
  ```

  - `system.journal`: chứa log của toàn hệ thống(kernel, service, daemon, boot, ...)
  - `user-UID.journal`: chứa log của từng user

2) Vị trí các journal file
- Vị trí phụ thuộc vào cấu hình trong `/etc/systemd/journald.conf`:

  | Storage=                                                  | Đường dẫn lưu                    |
  | --------------------------------------------------------- | -------------------------------- |
  | `persistent` hoặc `auto` (nếu `/var/log/journal` tồn tại) | `/var/log/journal/<machine-id>/` |
  | `volatile`                                                | `/run/log/journal/<machine-id>/` |

- Ví dụ:

  ```swift
  /var/log/journal/e9af6ca5a8fb4a70b2ddec4b1894014d/
  ```

  - Trong đó chuỗi `e9af6ca5a8fb4a70b2ddec4b1894014d` là machine-id(một định danh duy nhất cho hệ thống)

3) File đang hoạt động và file đã lưu trữ
- File đang hoạt động(active):
  - `system.journal`
  - `user-1000.journal`
  - Đây là nơi journald đang ghi log mới vào
- File đã lưu trữ(archived):
  - Các file có dạng:

    ```bash
    system@<UUID>-<offset1>-<offset2>.journal
    user-1000@<UUID>-<offset1>-<offset2>.journal
    ```

  - Những file này được tạo ra sau khi log cũ bị rotate - tức journald đã đầy và tạo file mới.

4) Khi nào journald rotate file log
- khi đạt tới giới hạn kích thước hoặc thời gian, được điều chỉnh bằng các directive trong `/etc/systemd/journald.conf`:

  | Directive            | Ý nghĩa                                     | Ví dụ                    |
  | -------------------- | ------------------------------------------- | ------------------------ |
  | `SystemMaxFileSize=` | Kích thước tối đa 1 file log                | `SystemMaxFileSize=100M` |
  | `SystemMaxUse=`      | Tổng dung lượng journald được phép dùng     | `SystemMaxUse=1G`        |
  | `MaxFileSec=`        | Tuổi tối đa của 1 file log (theo thời gian) | `MaxFileSec=1month`      |

- Khi vượt qua giới hạn này, file `system.journal` cũ sẽ:
  - Được đóng lại và đổi thành file archived
  - journald tạo ra file system.journal mới để ghi tiếp

5) Xem danh sách journal file
  ```bash
  ls -l /var/log/journal/<machine-id>
  ```

6) Xem log trong file archived

- Dùng:
  
  ```bash
  journalctl --file=/var/log/journal/<machine-id>/system@...journal
  ```

- Hoặc xem toàn bộ (cả archived và active):

  ```bash
  journalctl
  ```