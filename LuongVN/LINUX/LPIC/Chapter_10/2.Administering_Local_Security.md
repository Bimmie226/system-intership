# ADMINISTERING LOCAL SECURITY
## Securing Passwords
- Tất cả các thông tin tài khoản (user) được lưu trong `/etc/passwd`
- Nhưng file này tất cả mọi người đều đọc được nên mật khẩu nằm ở đây rất nguy hiểm
- Do đó mật khẩu được di chuyển sang `/etc/shadow`, ko ai ngoài root có quyền đọc
- Muốn đổi mk ta phải dùng quyền `sudo`

### Dealing with Password Problems

- Sử dụng lệnh `chage` để kiểm tra lại thông tin tài khoản có bị hết hạn hay không

  ![alt text](../images/10_2_01.png)

- Nếu tài khoản đã hết hạn, hãy sử dụng tùy chọn `-E` để đặt ngày hết hạn mới cho tài khoản.

## Limiting root Access
- Nguyên tắc quản lý tài khoản giúp tăng cường bảo mật hệ thống:
  - Không cho phép truy cập trực tiếp vào tài khoản root
  - Mỗi người chỉ dùng một tài khoản riêng
  - Đặt ngày hết hạn cho tài khoản tạm thời
  - Xóa các tài khoản không còn sử dụng

### Switching the User with `su`
- Lệnh `su` (switch user) dùng để chuyển sang tài khoản khác (thường là `root`) hoặc thực thi lệnh với quyền của tài khoản khác.
- `su -`: chuyển hẳn sang tk khác (thường là `root`). Trên Ubuntu, bị chặn mặc định, nên không đăng nhập root theo cách này.
- `su - <username>` -> chuyển sang người dùng khác

### Doing the Job as a Super User with `sudo`
- file cấu hình sudo chính: `/etc/sudoers` 
  - Không chỉnh sửa trực tiếp! Dùng lệnh `visudo` để chỉnh sửa an toàn.
  - Cú pháp cơ bản:

    ```bash
    USERNAME HOST=(USER:GROUP) COMMANDS
    ```

    ```bash
    root ALL=(ALL:ALL) ALL
    ```

    -> root có thể chạy bất kỳ lệnh nào, trên mọi host, với tư cách bất kỳ user/group nào.

  - Các dòng bắt đầu bằng `%` là nhóm người dùng:

    ```bash
    %sudo ALL=(ALL:ALL) ALL
    ```

    -> mọi người trong nhóm `sudo` đều có quyền `sudo`
- Thay vì chỉnh sửa trực tiếp `/etc/sudoers`, nên tạo file log riêng trong `/etc/sudoers.d/`
  - Dòng `#includedir /etc/sudoers.d` trong file chính cho phép load thêm các file con

## Auditing User Access
### Understanding the `who` and `w` Utilities
- Với lệnh `who`, ta có thể xem thông tin liên quan đến tài khoản của mình hoặc xem mọi người dùng hiện thại trên hệ thống.

  ![alt text](../images/10_2_02.png)

- Để xem cửa sổ hiện tại sử dụng user nào, hãy sử dụng `whoami`

  ![alt text](../images/10_2_03.png)

- Sử dụng lệnh `w` cũng có kết quả tương tự `who` nhưng nó mang nhiều thông tin hơn.

  ![alt text](../images/10_2_04.png)

  | Cột        | Ý nghĩa                                                                            |
  | ---------- | ---------------------------------------------------------------------------------- |
  | **USER**   | Tên người dùng đang đăng nhập (`luongvn`)                                          |
  | **TTY**    | Loại terminal: `tty1` là đăng nhập trực tiếp (local console), `pts/0` là phiên SSH |
  | **FROM**   | Nơi đăng nhập đến: `-` là local, `192.168.174.1` là IP từ xa                       |
  | **LOGIN@** | Thời điểm đăng nhập (giờ:phút)                                                     |
  | **IDLE**   | Thời gian không hoạt động (idle) của người dùng                                    |
  | **JCPU**   | Thời gian CPU được dùng bởi tất cả tiến trình trong phiên                          |
  | **PCPU**   | Thời gian CPU được dùng bởi tiến trình hiện tại                                    |
  | **WHAT**   | Tiến trình hiện đang chạy, ví dụ: `-bash`, `sshd: luongvn [priv]`                  |

### Displaying Access History with the `last` Utility
- Lệnh `last` lấy thông tin từ file `/var/log/wtmp` và hiển thị danh sách các tài khoản hiển thị lần cuối cùng họ đăng nhập hoặc đăng xuất khỏi hệ thống.

  ![alt text](../images/10_2_06.png)

## Setting Login, Process, and Memory Limits
- lệnh `ulimit` cho phép hạn chế quyền truy cập vào tài nguyên hệ thống cho mỗi tài khoản người dùng
- Xem giới hạn tài nguyên của người dùng:

  ![alt text](../images/10_2_05.png)

## Locating SUID/SGID Files
- SUID (Set User ID):
  - Khi một file có quyền SUID, bất kỳ ai chạy file đó sẽ thừa hưởng quyền của chủ sở hữu file đó (thường là `root`)
  
    -> Ví dụ: Lệnh `passwd` có SUID để cho phép người dùng thay đổi mật khẩu của chính họ, vì việc này cần quyền ghi vào `/etc/shadow`.
  
- SGID(Set Group ID):
  - Khi một file có quyền SGID, tiến trình khi chạy sẽ thừa hưởng quyền của nhóm sở hữu file đó.

    -> Thường dùng trong các thư mục dùng chung hoặc chương trình quản lý nhóm.

- Cách tìm file có SUID hoặc SGID
  
  ```bash
  sudo find / -perm /6000 -type f > SUID-SGID_Audit.txt
  ```

  | Thành phần       | Ý nghĩa                                                                               |
  | ---------------- | ------------------------------------------------------------------------------------- |
  | `/`              | Bắt đầu tìm từ thư mục gốc của hệ thống.                                              |
  | `-perm /6000`    | Tìm tất cả file có bit **SUID (4xxx)** hoặc **SGID (2xxx)** được bật. Số `6` = 4 + 2. |
  | `-type f`        | Chỉ tìm file (bỏ qua thư mục, link, socket…).                                         |

- So sánh audit mới và cũ:
  - Nếu tạo audit định kỳ (ví dụ mỗi tháng), ta có thể so sánh hai bản báo cáo:

    ```bash
    diff SUID-SGID_Audit.txt SUID-SGID_Audit_June-13.txt
    ```

  - Để tìm ra xem có file mới xuất hiện với quyền SUID/SGID không?

